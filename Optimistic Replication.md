# 乐观复制

## 什么是复制
分布式系统里面使得系统具有高可用性、高性能的一种关键技术

#### 高可用性：当前存储数据的地址无法访问，建立副本保证了数据访问的高可用性

#### 高性能：
1、在离用户访问节点近的地方建立副本，提高访问的速度，节省网络时延
2、分布式环境中，当大规模数据一次性被访问时，可以通过多节点同时服务用户来提高数据的吞吐量，同时也可以服务更多的用户
       
#### 副本存在的问题
1、保持副本的一致性
2、操作冲突



## 悲观复制
悲观复制采用传统的方式解决副本使用过程中存在的问题：
- 在数据更新到最新之前，数据访问被阻塞；
- 适用于本地局域网，延迟小，失败率低

对于长距离的广域网不能具有良好的可用性和性能，原因如下：
- 广域网可靠性低，速度慢，这导致副本间的延迟很难进行评估,如果拥有副本的位置(site)无法工作，则副本之间的通信就会出现问题。特点：悲观复制要求所有的副本都保持一致，且在完成更新之前，副本的数据都无法被访问。
- 悲观复制在广阔的区域内的延展性低,当悲观复制系统中存储副本的位置（site）越来越多,更新操作的频率越来越高，那么系统的吞吐量及可用性将会遭受很大的考验。
- 在某些情况下。悲观复制将变的不合适，例如，软件开发,开发者在相对隔离的环境下进行开发，他们可能对同一个数据进行修改，或者修复偶然的冲突，这种情况下，如果一个开发人员在编辑的时候，阻塞数据访问将变得不太现实。
  
## 乐观复制
目标和挑战：乐观复制系统的目标是提供对“足够新”数据的随时访问，以及最小化用户对分歧数据的困惑。

#### 乐观复制的6要素：

1、目标（object）, 副本（replica）, 位置（site）
目标：复制的最小单元，副本就是目标的复制品，存储在site中。site可以进行目标更新的site成为master site，而其它的site, 存储的副本是只读的。  
N代表所有的副本数，M表示master site的书目。  

M=1（单master系统）：只有一个site有权限更新目标，如果其它site的用户进行了更新命令，则需要将命令传输到master site上再执行，在这个模式下，操作的冲突将会被避免，当更新命令的频率很高时，这种模式下的可用性将会受到限制。  

M=N：多命令系统中，更新命令的应用与交换将会在后台进行，其中操作调度以及冲突管理成为了该系统中很重要的两个问题。  

另一个问题是，
当同时更新的规模达到了O(M2)时，相对于单master系统和悲观复制系统，它是不可扩展的，这里我们假设每一个master site提交的更新命令的速率是恒定的。因此，当master site的数量增加时，并发的发生频率会比单master系统和悲观复制系统更高。

2、操作（operations）
  指令的定义：状态转移（state transfer）VS.操作转移
        状态转移系统中的操作：读、覆盖整个目标，退化形式的操作转移系统，保持最终状态
        操作转移系统中的操作：语义描述的操作，保持一连串的操作，更复杂，更有效，修改目标更加细节更加有效,拥有更加灵活的冲突决议

  不同：性质上的不同，保持一致性  
  
3、传播(propagation)
    本地提交的操作必须被传播到远端的所有副本，以保证副本的一致性。
    瘟疫传播（epidemic propagation）
    拓扑：拓扑结构和传播策略需要被同时考虑  
    
4、暂定执行和调度（tentative execution and scheduling）

调度：按照用户想要的顺序去执行一连串的操作来保持副本的一致性
语法调度：取决于操作何时何地由谁提交的，时间戳是最常用的工具
语义调度：根据操作的具体语义内容，可以减少冲突

5、检测和解决冲突（detecting and resolving conflict）  

冲突检测：语法检测、语义检测  

语法冲突：仅通过并发更新的出现来标示冲突的系统，检测的是语法冲突。比如，文件系统对同一文件的任意并发写冲突，
适用这种策略。  

语义冲突：利用应用语义从良性并发更新中区分出冲突。比如，采用语义冲突检测的文件系统，允许对同一目录下不同文件的
并发更新。创建文件“X”与删除文件“Y”不会冲突。

不检测冲突——Thomas写规则：对哪个副本存储了最新内容达成一致（时间戳）

6、提交（commitment）
    一致性
    一致性，也被称作最终一致性，要求无论更新在哪里、在何时发生，以及无论它们以何种顺序被每个站点接收，所有副本的内容将
    最终获得一致。一致性作为乐观复制系统最重要目标有两个原因。首先，如果没有这个保证，副本内容可能会永远是错的。其次，
    最终一致性服务通常尽最大努力在站点间快速传播更新，同时这样的努力对大多是应用是足够和实用的。  
    一致性通过结合四个过程来实现，如图1所描述：  
    - 可靠的更新传播(b)  
    - 明确的更新调度（c）  
    - 冲突检测和解决(d)  
    - 和更新提交(e)

        
![](http://ww1.sinaimg.cn/large/6e5586c6ly1g63z6vofb5j20fi0c1ab2.jpg)


 ## 实例分析
   The note system
   组通信系统： 分享信息
   
   例如，软件开发人员使用该系统进行软件项目管理，开发人员不是持续通信的。
   网络： rarely connected network，因此保持一致性的成本就会很高，甚至是不可能的，但是该系统并不要求副本之间有这一层级的一致性。
   基于为特定的开发项目组量身定制的文件共享的数据库
   
   特征：
   1、组内通信不是点对点，而是多对多,通过添加文件到复制的数据库来实现
   2、用户不需要看到严格的更新信息，同时当一个指令被发出时，应用程序也不是很大程度上依赖于被修改的文件。
   3、指令必须执行在所有的副本中，或者不执行
   
   基础复制目标总结：
   后台复制，断续连接网络，多master数据库
   
   时间戳：上次更新的时间
   
   复制算法：
 -----------------------------------------------------------------
 https://blog.csdn.net/xiaoqiangxx/article/details/8967426
